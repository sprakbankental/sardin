package MTM::Pronunciation::Conversion::Features;

#**********************************************************#
# This script takes a file with sentences as input and
# (1) Processes them with Sardin
# (2) Reads the Sardin outfile and creates
#	- phones.txt	a phone file for phone input
#	- feature.txt	a feature integer file (all features have integers, e.g. 1,2,3,4,5).
#	- feature01.txt	a feature file with values between 0 and 1
#**********************************************************#
# SBTal boilerplate
use strict;
use utf8;
use autodie;
use warnings;
use warnings    qw< FATAL  utf8 >;
use open        qw< :std  :utf8 >;     # Should perhaps be :encoding(utf-8)?
use charnames   qw< :full :short >;    # autoenables in v5.16 and above
use feature     qw< unicode_strings >;
no feature      qw< indirect >;      
use feature     qw< signatures >;
no warnings     qw< experimental::signatures >;
# END SBTal boilerplate

my $n_feats = 13;

my %base2features = ();

my %features = ();
my %features01 = ();

read_data();
#**********************************************************#
sub convert {
	my $self = shift;
	my $phones = shift;
	my $lang = shift;
	
	my @features = ();
	my @features01 = ();
	
	my $stress = 'void';
	my $stress01 = 'void';
	
	# Remove within-word boundaries.
	$phones =~ s/ [\.\~\-] / /g;

	# Add word boundaries and sent final token
	#$phones =~ s/ \&/ \./g;
	#$phones =~ s/ \| / \& /g;
	
	my @phones = split/ /, $phones;
	my $p_counter = 0;
	foreach my $p ( @phones ) {
	
		# FEATURES 0-1
		# Boundaries
		if( $p =~ /^[\&\/\.]$/ ) {
			push @features01, $p;

		# Stress are separate $p that are merged with the vowel.
		} elsif( $p =~ /^([\'\"\,])$/ ) {
			$stress01 = $1;
			#print "stress01 $stress01\n";
		
		} elsif( exists( $features01{ $p } )) {
			my $f = $features01{ $p };
			my @f = split/,/, $f;
			my $n_c = $f =~ s/,/,/g;

			if( $stress01 !~ /void/ ) {
				#print "p01 has stress $p	$stress01\n"; sleep 1;
				if( $stress01 eq '"' ) {
					$f[2] = 1.00;
					$f[3] = 0.67;
				} elsif( $stress01 =~ /^\'$/ ) {
					$f[2] = 1.00;
					$f[3] = 0.33;
				} elsif( $stress01 eq ',' ) {
					$f[2] = 0.50;
					$f[3] = 1.00;
				} else {
					print "unknown stress: $stress01\n";
				}
			}
			# Adjacent nasals: add 0.25 nasality for each (vowels only)
			if( $p_counter != 0 && $phones[ $p_counter-1 ] =~ /^(m|n|ng)$/ && $f[5] == 0 ) {
				$f[7] += 0.25 if $f[7] < 1;
				#print "LC1 $phones[ $p_counter-1 ]	$p	$f[7]\n";
			} elsif ( $p_counter != 1 && $phones[ $p_counter-1 ] =~ /[\"\'\,]/ && $phones[ $p_counter-2 ] =~ /^(m|n|ng)$/ && $f[5] == 0 ) {
				$f[7] += 0.25 if $f[7] < 1;
				#print "LC2 $phones[ $p_counter-2 ] $phones[ $p_counter-1 ]	$p	$f[7]\n";
			}
			if( $p_counter != $#phones && $phones[ $p_counter+1 ] =~ /^(m|n|ng)$/ && $f[5] == 0 ) {
				$f[7] += 0.25 if $f[7] < 1;
				#print "RC1 $p	$phones[ $p_counter+1 ]	$f[7]\n";
			}

			if( $lang eq 'eng' ) {
				$f[0] = "1.00";
			}
						
			if( $#f != $n_feats ) {
				warn "features01 has $n_feats featurse: @f\n";
			}
			
			foreach my $c ( @f ) {
				$c = sprintf("%.2f", $c);
			}
			
			$f = join',', @f;
			push @features01, $f;
			$stress01 = 'void';
		} else {
			print "UNKNOWN	$p ___	$phones\n";
		}
		$p_counter++;
		
		# print "Features: $p	@features01\n";
		
	}	

	my $features01 = join' ', @features01;
	return( $features01 );
}
#******************************************************************#
sub read_data {
	
	my $features = 0;
	my $features01 = 0;
	
	while(<DATA>) {
		chomp;
		s/[\r\n]//g;
		if ( /\# Features_/ ) {
			$features = 1;
			next;
		# Features with values 0 to 1
		} elsif ( /\# Features01/ ) {
			$features01 = 1;
			$features = 0;
			next;
		}
		
		
		if ( $features == 1 ) {
			my( $a, $b ) = split/\t/;
			$features{ $a } = $b;
		} elsif ( $features01 == 1 ) {
			my( $a, $b ) = split/\t/;
			$features01{ $a } = $b;
		}
	}
	close DATA;
}
#**********************************************************#
__DATA__
# Features_
p	0,0,0,0,0,1,0,0,0,5,0,0,0,0
b	0,0,0,0,0,1,1,0,0,5,0,0,0,0
t	0,0,0,0,0,1,0,0,0,5,4,0,0,0
rt	0,0,0,0,0,1,0,0,1,5,6,0,0,0
d	0,0,0,0,0,1,1,0,0,5,4,0,0,0
rd	0,0,0,0,0,1,1,0,1,5,6,0,0,0
k	0,0,0,0,0,1,0,0,0,5,8,0,0,0
g	0,0,0,0,0,1,1,0,0,5,8,0,0,0
f	0,0,0,0,0,1,0,0,0,4,1,0,0,0
v	0,0,0,0,0,1,1,0,0,4,1,0,0,0
s	0,0,0,0,0,1,0,0,0,4,4,0,0,0
rs	0,0,0,0,0,1,0,0,1,4,6,0,0,0
sh	0,0,0,0,0,1,0,0,0,4,5,0,0,0
zh	0,0,0,0,0,1,1,0,0,4,5,0,0,0
z	0,0,0,0,0,1,1,0,0,4,4,0,0,0
dh	0,0,0,0,0,1,1,0,0,4,3,0,0,0
th	0,0,0,0,0,1,0,0,0,4,3,0,0,0
h	0,0,0,0,0,1,1,0,0,4,10,0,0,0
x	0,0,0,0,0,1,1,0,0,4,8,0,0,0
xx	0,0,0,0,0,1,1,0,0,4,9,0,0,0
c	0,0,0,0,0,1,0,0,0,4,7,0,0,0
m	0,0,0,0,0,1,1,1,1,5,0,0,0,0
n	0,0,0,0,0,1,1,1,1,5,4,0,0,0
rn	0,0,0,0,0,1,1,1,1,5,6,0,0,0
ng	0,0,0,0,0,1,1,1,1,5,8,0,0,0
r	0,0,0,0,0,1,1,0,1,3,4,0,0,0
l	0,0,0,0,0,1,1,0,0,2,4,0,0,0
rl	0,0,0,0,0,1,1,0,1,2,6,0,0,0
j	0,0,0,0,0,1,1,0,0,1,7,0,0,0
w	0,0,0,0,0,1,1,0,0,1,8,0,0,0
rh	0,0,0,0,0,1,1,0,1,2,4,0,0,0
rx	0,0,0,0,0,1,1,0,1,2,7,0,0,0
i:	0,0,0,0,1,0,1,0,0,0,0,0,0,0
i	0,0,0,0,0,0,1,0,0,0,0,1,1,0
ih	0,0,0,0,0,0,1,0,0,0,0,0,1,0
y:	0,0,0,0,1,0,1,0,0,0,0,1,0,1
y	0,0,0,0,0,0,1,0,0,0,0,0,1,1
e:	0,0,0,0,1,0,1,0,0,0,0,2,0,0
e	0,0,0,0,0,0,1,0,0,0,0,3,0,0
eh	0,0,0,0,0,0,1,0,0,0,0,2,0,0
ex	0,0,0,0,0,0,1,0,0,0,0,3,2,0
ä:	0,0,0,0,1,0,1,0,0,0,0,3,0,0
ae:	0,0,0,0,1,0,1,0,0,0,0,4,0,0
ae	0,0,0,0,0,0,1,0,0,0,0,4,0,0
ö:	0,0,0,0,1,0,1,0,0,0,0,2,0,1
ö	0,0,0,0,0,0,1,0,0,0,0,2,0,1
oe:	0,0,0,0,1,0,1,0,0,0,0,4,0,1
oe	0,0,0,0,0,0,1,0,0,0,0,4,0,1
u:	0,0,0,0,1,0,1,0,0,0,0,0,4,1
u	0,0,0,0,0,0,1,0,0,0,0,0,4,1
oh	0,0,0,0,0,0,1,0,0,0,0,1,4,1
o:	0,0,0,0,1,0,1,0,0,0,0,2,4,1
o	0,0,0,0,0,0,1,0,0,0,0,3,4,1
uu:	0,0,0,0,1,0,1,0,0,0,0,0,2,1
uu	0,0,0,0,0,0,1,0,0,0,0,3,2,1
uuh	0,0,0,0,0,0,1,0,0,0,0,1,2,1
uw:	0,0,0,0,1,0,1,0,0,0,0,0,3,1
uw	0,0,0,0,0,0,1,0,0,0,0,1,3,1
a:	0,0,0,0,1,0,1,0,0,0,0,5,4,0
a	0,0,0,0,0,0,1,0,0,0,0,5,1,0
aa:	0,0,0,0,1,0,1,0,0,0,0,5,1,0
an	0,0,0,0,0,0,1,1,0,0,0,5,4,0
en	0,0,0,0,0,0,1,1,0,0,0,3,0,0
on	0,0,0,0,0,0,1,1,0,0,0,2,4,1
un	0,0,0,0,0,0,1,1,0,0,0,4,0,1
#\'	0,0,2,1,0,0,0,0,0,0,0,0,0,0
#\"	0,0,2,2,0,0,0,0,0,0,0,0,0,0
#,	0,0,1,3,0,0,0,0,0,0,0,0,0,0
#.	0,1,0,0,0,0,0,0,0,0,0,0,0,0
#~	0,2,0,0,0,0,0,0,0,0,0,0,0,0
#-	0,3,0,0,0,0,0,0,0,0,0,0,0,0
#|	0,4,0,0,0,0,0,0,0,0,0,0,0,0
#/	0,5,0,0,0,0,0,0,0,0,0,0,0,0
#&	0,6,0,0,0,0,0,0,0,0,0,0,0,0
# Features01
p	0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00
b	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00
t	0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,1.00,0.40,0.00,0.00,0.00
rt	0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,1.00,1.00,0.60,0.00,0.00,0.00
d	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,1.00,0.40,0.00,0.00,0.00
rd	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,1.00,1.00,0.60,0.00,0.00,0.00
k	0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,1.00,0.80,0.00,0.00,0.00
g	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,1.00,0.80,0.00,0.00,0.00
f	0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.80,0.10,0.00,0.00,0.00
v	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.80,0.10,0.00,0.00,0.00
s	0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.80,0.40,0.00,0.00,0.00
rs	0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,1.00,0.80,0.60,0.00,0.00,0.00
sh	0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.80,0.50,0.00,0.00,0.00
zh	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.80,0.50,0.00,0.00,0.00
z	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.80,0.40,0.00,0.00,0.00
dh	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.80,0.30,0.00,0.00,0.00
th	0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.80,0.30,0.00,0.00,0.00
h	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.80,1.00,0.00,0.00,0.00
x	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.80,0.80,0.00,0.00,0.00
xx	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.80,0.90,0.00,0.00,0.00
c	0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.80,0.70,0.00,0.00,0.00
m	0.00,0.00,0.00,0.00,0.00,1.00,1.00,1.00,1.00,1.00,0.00,0.00,0.00,0.00
n	0.00,0.00,0.00,0.00,0.00,1.00,1.00,1.00,1.00,1.00,0.40,0.00,0.00,0.00
rn	0.00,0.00,0.00,0.00,0.00,1.00,1.00,1.00,1.00,1.00,0.60,0.00,0.00,0.00
ng	0.00,0.00,0.00,0.00,0.00,1.00,1.00,1.00,1.00,1.00,0.80,0.00,0.00,0.00
r	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,1.00,0.60,0.40,0.00,0.00,0.00
l	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.40,0.40,0.00,0.00,0.00
rl	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,1.00,0.40,0.60,0.00,0.00,0.00
j	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.20,0.70,0.00,0.00,0.00
w	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.20,0.80,0.00,0.00,0.00
rh	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,1.00,0.40,0.40,0.00,0.00,0.00
rx	0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,1.00,0.40,0.70,0.00,0.00,0.00
i:	0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00
i	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.20,0.25,0.00
ih	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00,0.25,0.00
y:	0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.20,0.00,1.00
y	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00,0.25,1.00
e:	0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.40,0.00,0.00
e	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.60,0.00,0.00
eh	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.40,0.00,0.00
ex	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.60,0.50,0.00
ä:	0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.60,0.00,0.00
ae:	0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.80,0.00,0.00
ae	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.80,0.00,0.00
ö:	0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.40,0.00,1.00
ö	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.40,0.00,1.00
oe:	0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.80,0.00,0.50
oe	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.80,0.00,0.50
u:	0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00,1.00,0.50
u	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00,1.00,0.50
oh	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.20,1.00,0.50
o:	0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.40,1.00,0.50
o	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.60,1.00,0.50
uu:	0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00,0.50,1.00
uu	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.60,0.50,1.00
uuh	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.20,0.50,1.00
uw:	0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,0.00,0.75,0.50
uw	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,0.20,0.75,0.50
a:	0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00
a	0.00,0.00,0.00,0.00,0.00,0.00,1.00,0.00,0.00,0.00,0.00,1.00,0.25,0.00
aa:	0.00,0.00,0.00,0.00,1.00,0.00,1.00,0.00,0.00,0.00,0.00,1.00,0.25,0.00
an	0.00,0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,1.00,1.00,0.00
en	0.00,0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.60,0.00,0.00
on	0.00,0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.40,1.00,0.50
un	0.00,0.00,0.00,0.00,0.00,0.00,1.00,1.00,0.00,0.00,0.00,0.80,0.00,0.50
#\'	0.00,0.00,1.00,0.33,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00
#\"	0.00,0.00,1.00,0.67,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00
#,	0.00,0.00,0.50,1.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00
#.	0.00,0.17,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00
#~	0.00,0.33,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00
#-	0.00,0.50,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00
#|	0.00,0.67,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00
#/	0.00,0.83,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00
#&	0.00,1.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00
